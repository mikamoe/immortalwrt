name: Build luci-theme-design (js)

on:
  workflow_dispatch:

jobs:
  build-theme:
    runs-on: ubuntu-latest
    env:
      MAKEFLAGS: -j$(nproc)
      THEME_REPO: https://github.com/0x676e67/luci-theme-design.git
      THEME_BRANCH: js
      THEME_DIR: package/luci-theme-design

    steps:
      - name: Checkout ImmortalWrt Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # use your fork branch
          ref: openwrt-24.10

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache libncurses5-dev libssl-dev git wget python3-distutils

      - name: Setup ccache
        run: |
          mkdir -p ~/.ccache
          echo "max_size = 2.0G" > ~/.ccache/ccache.conf

      - name: Cache dl and ccache
        uses: actions/cache@v4
        with:
          path: |
            dl
            ~/.ccache
          key: ${{ runner.os }}-openwrt-dl-${{ github.ref }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-

      - name: Clone luci-theme-design js branch
        run: |
          git clone --depth 1 -b $THEME_BRANCH $THEME_REPO $THEME_DIR

      - name: Update feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate minimal config
        run: |
          make defconfig
          # enable theme only
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_luci-theme-design=y" >> .config
          make defconfig

      - name: Compile theme package
        run: |
          make package/luci-theme-design/compile V=s

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-design-ipk
          path: |
            bin/**/*.ipk
