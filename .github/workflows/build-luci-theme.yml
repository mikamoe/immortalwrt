name: Build luci-theme-design (js) for MT798x Filogic

on:
  workflow_dispatch:

jobs:
  build-theme:
    runs-on: ubuntu-latest

    env:
      MAKEFLAGS: -j$(nproc)
      THEME_REPO: https://github.com/0x676e67/luci-theme-design.git
      THEME_BRANCH: js
      THEME_DIR: package/luci-theme-design

    steps:
      - name: Checkout ImmortalWrt source
        uses: actions/checkout@v4
        with:
          ref: openwrt-24.10
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            ccache \
            git \
            wget \
            curl \
            unzip \
            rsync \
            gawk \
            gettext \
            libncurses5-dev \
            libssl-dev \
            python3 \
            python3-setuptools

      - name: Setup ccache
        run: |
          mkdir -p ~/.ccache
          echo "max_size = 2G" > ~/.ccache/ccache.conf

      - name: Cache dl and ccache
        uses: actions/cache@v4
        with:
          path: |
            dl
            ~/.ccache
          key: ${{ runner.os }}-openwrt-mediatek-filogic
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: Clone luci-theme-design (js branch)
        run: |
          git clone --depth 1 -b $THEME_BRANCH $THEME_REPO $THEME_DIR

      - name: Update and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate .config for Cudy TR3000 (MT798x)
        run: |
          cat > .config << 'EOF'
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_cudy_tr3000_256m_v1=y

          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_luci-theme-design=y
          EOF

          make defconfig

      - name: Compile luci-theme-design only
        run: |
          make package/luci-theme-design/compile V=s

      - name: Upload ipk artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-design-ipk-mt798x
          path: |
            bin/targets/mediatek/filogic/packages/*.ipk
            bin/packages/*/luci-theme-design*.ipk
